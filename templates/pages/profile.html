{% extends 'base.html' %}
{% load static %}

{% block title %}Личный кабинет - ENGLER House{% endblock %}

{% block header_class %}h-40{% endblock %}
{% block header_style %}style="background: #2C2926"{% endblock %}

{% block hero_content %}

{% endblock %}

{% block page_content %}
<section class="bg-[#2C2926] pt-2 pb-16 max-md:pt-1 max-md:pb-12">
    <div class="max-w-[1300px] mx-auto w-full px-6 md:px-0">
        <h1 data-aos="fade-up" class="font-bold text-4xl md:text-[64px] text-white leading-[113%] mb-6">
            Мои проекты
        </h1>
        <p data-aos="fade-up" data-aos-delay="100" class="text-base md:text-lg font-medium text-white/80 leading-[134%]">
            Отслеживайте статус ваших заказов и прогресс выполнения проектов
        </p>
    </div>
</section>
<!-- Orders Section -->
<section class="bg-[#2C2926] pt-8 pb-16">
    <div class="max-w-[1300px] mx-auto px-6 md:px-0">
        {% if orders %}
            {% for order in orders %}
            <div data-aos="fade-up" {% if not forloop.first %}data-aos-delay="{{ forloop.counter|add:0|add:0 }}"{% endif %} 
                class="bg-[#564F40] rounded-lg overflow-hidden mb-12 last:mb-0">
                
                <!-- Order Header -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8 p-8 md:p-10">
                    <!-- Project Image -->
                    <div class="md:col-span-1">
                        <img src="{{ order.project_image.url }}" alt="{{ order.client_name }}" 
                            class="w-full h-48 md:h-full object-cover rounded-lg">
                    </div>
                    
                    <!-- Order Info -->
                    <div class="md:col-span-2 flex flex-col justify-between">
                        <div>
                            <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4">
                                <h2 class="text-2xl md:text-3xl font-bold text-white mb-2 md:mb-0">
                                    Статус заказа #{{ order.order_number }}
                                </h2>
                                <span class="inline-flex items-center px-4 py-2 rounded-full text-sm font-semibold w-max
                                    {% if order.status == 'completed' %}bg-green-500 text-white
                                    {% elif order.status == 'in_progress' %}bg-blue-500 text-white
                                    {% elif order.status == 'pending' %}bg-yellow-500 text-white
                                    {% else %}bg-red-500 text-white{% endif %}">
                                    {% if order.status == 'completed' %}✓ Завершен
                                    {% elif order.status == 'in_progress' %}⏱ В работе
                                    {% elif order.status == 'pending' %}⏳ Ожидание
                                    {% else %}✗ Отменен{% endif %}
                                </span>
                            </div>
                            
                            <h3 class="text-xl md:text-2xl font-semibold text-white mb-6">{{ order.user.full_name }}</h3>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                                <div>
                                    <p class="text-white/60 text-sm mb-1">Дата старта проекта</p>
                                    <p class="text-white font-medium">{{ order.start_date|date:"d.m.Y" }}</p>
                                </div>
                                <div>
                                    <p class="text-white/60 text-sm mb-1">Дата сдачи проекта</p>
                                    <p class="text-white font-medium">{{ order.end_date|date:"d.m.Y" }}</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Progress Bar -->
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-white/80 text-sm font-medium">Прогресс выполнения</span>
                                <span class="text-white font-bold">{{ order.get_progress_percentage }}%</span>
                            </div>
                            <div class="w-full bg-[#2C2926] rounded-full h-3">
                                <div class="bg-gradient-to-r from-[#564F40] to-white h-3 rounded-full transition-all duration-500" 
                                    style="width: {{ order.get_progress_percentage }}%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Status Indicators inside main card -->
                <div class="px-8 md:px-10 pb-8 md:pb-10">
                    <div class="flex flex-col sm:flex-row flex-wrap gap-3">
                        <div class="flex items-center gap-1.5 bg-white/20 px-3 py-2 rounded-full w-full sm:w-auto justify-center sm:justify-start">
                            <div class="w-3 h-3 rounded-full bg-green-500"></div>
                            <span class="text-white text-sm font-semibold">Завершено</span>
                        </div>
                        <div class="flex items-center gap-1.5 bg-white/20 px-3 py-2 rounded-full w-full sm:w-auto justify-center sm:justify-start">
                            <div class="w-3 h-3 rounded-full bg-blue-500"></div>
                            <span class="text-white text-sm font-semibold">В работе</span>
                        </div>
                        <div class="flex items-center gap-1.5 bg-white/20 px-3 py-2 rounded-full w-full sm:w-auto justify-center sm:justify-start">
                            <div class="w-3 h-3 rounded-full bg-gray-400"></div>
                            <span class="text-white text-sm font-semibold">Ожидание</span>
                        </div>
                    </div>
                </div>
                
                <!-- Gantt Chart -->
                {% if order.task_list %}
                <div class="bg-white p-3 md:p-8">
                    <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between md:gap-0 mb-3 md:mb-6">
                        <h3 class="text-base md:text-2xl font-bold text-[#291F1E]">Гант-диаграмма</h3>
                        <button onclick="openFeedbackModal()" 
                            class="text-[10px] md:text-base text-[#564F40] hover:text-[#291F1E] active:text-[#291F1E] font-semibold transition-colors flex items-center gap-1 md:gap-2 px-2 py-1 md:px-0 md:py-0 bg-[#564F40]/5 md:bg-transparent rounded md:rounded-none self-start">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-3 h-3 md:w-5 md:h-5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="m4.5 19.5 15-15m0 0H8.25m11.25 0v11.25" />
                            </svg>
                            <span class="whitespace-nowrap">Отследить статус проекта</span>
                        </button>
                    </div>
                    
                    <!-- Timeline Header -->
                    <div class="flex items-center justify-between mb-2 md:mb-4 text-[9px] md:text-sm text-[#291F1E]/60 font-semibold bg-gray-50 md:bg-transparent py-1.5 px-2 md:py-0 md:px-0 rounded-md">
                        <span>{{ order.timeline_start|date:"d.m.Y" }}</span>
                        <span class="text-center px-2 text-[#291F1E]/80">{{ order.total_duration_days }} дн.</span>
                        <span>{{ order.timeline_end|date:"d.m.Y" }}</span>
                    </div>
                    
                    <!-- Gantt Chart Container -->
                    <div class="space-y-6 md:space-y-4">
                        {% for task in order.task_list %}
                        <div class="gantt-row group">
                            <div class="flex flex-col gap-1.5 md:gap-3">
                                <!-- Task Header -->
                                <div class="flex items-center justify-between gap-2">
                                    <h4 class="font-bold text-[#291F1E] text-xs md:text-lg flex-1">{{ task.title }}</h4>
                                    <span class="text-[9px] md:text-sm text-[#291F1E]/60 font-semibold whitespace-nowrap bg-gray-100 md:bg-transparent px-1.5 py-0.5 md:px-0 md:py-0 rounded">
                                        {{ task.get_duration_days }} дн.
                                    </span>
                                </div>
                                
                                <!-- Timeline Bar with Dates -->
                                <div class="relative">
                                    <!-- Background Timeline -->
                                    <div class="relative h-12 md:h-12 bg-gray-100 rounded-lg overflow-visible group">
                                        <!-- Progress Bar with info -->
                                        <div class="absolute h-full rounded-lg transition-all duration-300 cursor-pointer flex items-center justify-center px-1.5 md:px-2
                                            {% if task.status == 'completed' %}bg-green-500 hover:bg-green-600 active:bg-green-700 hover:shadow-lg
                                            {% elif task.status == 'in_progress' %}bg-blue-500 hover:bg-blue-600 active:bg-blue-700 hover:shadow-lg
                                            {% else %}bg-gray-400 hover:bg-gray-500 active:bg-gray-600 hover:shadow-md{% endif %}"
                                            style="left: {{ task.position_percent }}%; width: {{ task.width_percent }}%"
                                            onclick="this.querySelector('.task-tooltip').classList.toggle('hidden'); 
                                                     this.querySelector('.task-backdrop')?.classList.toggle('hidden');">
                                            
                                            <!-- Backdrop for mobile tooltip -->
                                            <div class="task-backdrop hidden md:!hidden fixed inset-0 bg-black/50 z-[99]"
                                                onclick="event.stopPropagation(); this.classList.add('hidden'); this.parentElement.querySelector('.task-tooltip').classList.add('hidden');"></div>
                                            
                                            <!-- Dates inside bar (visible on desktop only) -->
                                            <div class="hidden md:flex w-full items-center justify-between text-white font-bold text-xs">
                                                <span class="truncate">{{ task.start_date|date:"d.m" }}</span>
                                                <span class="text-center px-1 text-[10px]">{{ task.get_status_display }}</span>
                                                <span class="truncate">{{ task.end_date|date:"d.m" }}</span>
                                            </div>
                                            
                                            <!-- Tooltip (works on hover for desktop, click for mobile) -->
                                            <div class="task-tooltip hidden md:group-hover:flex absolute 
                                                fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2
                                                md:fixed md:top-auto md:left-auto md:translate-x-0 md:translate-y-0
                                                md:-top-24 md:left-1/2 md:-translate-x-1/2 md:bottom-auto
                                                bg-gray-900/95 md:bg-gray-900 text-white px-4 py-3 md:px-4 md:py-3 rounded-lg shadow-2xl 
                                                flex-col items-center
                                                w-[90vw] max-w-[280px] md:w-auto md:whitespace-nowrap md:min-w-[220px]
                                                z-[100]">
                                                <div class="text-xs md:text-sm font-bold mb-2 text-center">{{ task.title }}</div>
                                                <div class="w-full space-y-1">
                                                    <div class="flex justify-between text-[10px] md:text-xs gap-2">
                                                        <span class="text-gray-400">Начало:</span>
                                                        <span class="font-semibold">{{ task.start_date|date:"d.m.Y" }}</span>
                                                    </div>
                                                    <div class="flex justify-between text-[10px] md:text-xs gap-2">
                                                        <span class="text-gray-400">Конец:</span>
                                                        <span class="font-semibold">{{ task.end_date|date:"d.m.Y" }}</span>
                                                    </div>
                                                    <div class="flex justify-between text-[10px] md:text-xs gap-2">
                                                        <span class="text-gray-400">Длительность:</span>
                                                        <span class="font-semibold">{{ task.get_duration_days }} дней</span>
                                                    </div>
                                                </div>
                                                <div class="text-[10px] md:text-xs mt-2 px-3 py-1 rounded-full font-semibold
                                                    {% if task.status == 'completed' %}bg-green-500
                                                    {% elif task.status == 'in_progress' %}bg-blue-500
                                                    {% else %}bg-gray-500{% endif %}">
                                                    {{ task.get_status_display }}
                                                </div>
                                                <!-- Close button for mobile -->
                                                <button onclick="event.stopPropagation(); 
                                                    this.parentElement.classList.add('hidden'); 
                                                    this.parentElement.parentElement.querySelector('.task-backdrop')?.classList.add('hidden');" 
                                                    class="md:hidden absolute top-2 right-2 text-white/60 hover:text-white transition-colors">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                                                    </svg>
                                                </button>
                                                <!-- Arrow for desktop only -->
                                                <div class="hidden md:block absolute -bottom-2 left-1/2 -translate-x-1/2 w-3 h-3 bg-gray-900 rotate-45"></div>
                                            </div>
                                        </div>
                                        
                                        <!-- Status badge (mobile only - left or right side based on position) -->
                                        {% if task.position_percent|add:task.width_percent > 70 %}
                                        <!-- Show on the left if bar is on the right side -->
                                        <div class="md:hidden absolute top-1/2 -translate-y-1/2 flex items-center gap-1"
                                            style="right: calc(100% - {{ task.position_percent }}% + 8px);">
                                            <span class="inline-flex items-center gap-0.5 px-2 py-1 rounded-full text-[9px] font-semibold text-white whitespace-nowrap
                                                {% if task.status == 'completed' %}bg-green-500
                                                {% elif task.status == 'in_progress' %}bg-blue-500
                                                {% else %}bg-gray-500{% endif %}">
                                                {% if task.status == 'completed' %}✓
                                                {% elif task.status == 'in_progress' %}⏱
                                                {% else %}⏳{% endif %}
                                                {{ task.get_status_display }}
                                            </span>
                                        </div>
                                        {% else %}
                                        <!-- Show on the right if bar is on the left side -->
                                        <div class="md:hidden absolute top-1/2 -translate-y-1/2 flex items-center gap-1"
                                            style="left: calc({{ task.position_percent }}% + {{ task.width_percent }}% + 8px);">
                                            <span class="inline-flex items-center gap-0.5 px-2 py-1 rounded-full text-[9px] font-semibold text-white whitespace-nowrap
                                                {% if task.status == 'completed' %}bg-green-500
                                                {% elif task.status == 'in_progress' %}bg-blue-500
                                                {% else %}bg-gray-500{% endif %}">
                                                {% if task.status == 'completed' %}✓
                                                {% elif task.status == 'in_progress' %}⏱
                                                {% else %}⏳{% endif %}
                                                {{ task.get_status_display }}
                                            </span>
                                        </div>
                                        {% endif %}
                                        
                                        <!-- Dates below bar (visible on mobile only) -->
                                        <div class="md:hidden absolute top-full mt-1 left-0 right-0 flex justify-center pointer-events-none px-1">
                                            <div class="text-[10px] font-semibold bg-white/80 px-2 py-0.5 rounded whitespace-nowrap max-w-[calc(100%-8px)]"
                                                style="position: relative; left: calc({{ task.position_percent }}% + {{ task.width_percent }}% / 2 - 50%);">
                                                <span class="text-[#291F1E]/70">{{ task.start_date|date:"d.m" }} — {{ task.end_date|date:"d.m" }}</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Task Description (on hover) -->
                                    {% if task.description %}
                                    <div class="hidden group-hover:block absolute top-full left-0 right-0 mt-8 md:mt-2 p-3 bg-gray-800 text-white rounded-lg shadow-lg z-10 text-xs">
                                        <p>{{ task.description }}</p>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <!-- Legend -->
                    <div class="flex flex-wrap gap-2 md:gap-4 mt-3 md:mt-6 pt-3 md:pt-6 border-t border-gray-200">
                        <div class="flex items-center gap-1 md:gap-2 bg-gray-50 md:bg-transparent px-2 py-1 md:px-0 md:py-0 rounded-md">
                            <div class="w-2.5 h-2.5 md:w-4 md:h-4 rounded bg-green-500"></div>
                            <span class="text-[10px] md:text-sm text-[#291F1E]/80 font-semibold">Завершено</span>
                        </div>
                        <div class="flex items-center gap-1 md:gap-2 bg-gray-50 md:bg-transparent px-2 py-1 md:px-0 md:py-0 rounded-md">
                            <div class="w-2.5 h-2.5 md:w-4 md:h-4 rounded bg-blue-500"></div>
                            <span class="text-[10px] md:text-sm text-[#291F1E]/80 font-semibold">В работе</span>
                        </div>
                        <div class="flex items-center gap-1 md:gap-2 bg-gray-50 md:bg-transparent px-2 py-1 md:px-0 md:py-0 rounded-md">
                            <div class="w-2.5 h-2.5 md:w-4 md:h-4 rounded bg-gray-400"></div>
                            <span class="text-[10px] md:text-sm text-[#291F1E]/80 font-semibold">Ожидание</span>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="bg-white p-6 md:p-8 text-center">
                    <p class="text-[#291F1E]/60">Этапы проекта скоро появятся</p>
                </div>
                {% endif %}
            </div>
        {% endfor %}
        {% else %}
        <div class="bg-[#564F40] rounded-lg p-12 text-center" data-aos="fade-up">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-16 h-16 mx-auto mb-4 text-white/60">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 0 1 6 3.75h2.25A2.25 2.25 0 0 1 10.5 6v2.25a2.25 2.25 0 0 1-2.25 2.25H6a2.25 2.25 0 0 1-2.25-2.25V6ZM3.75 15.75A2.25 2.25 0 0 1 6 13.5h2.25a2.25 2.25 0 0 1 2.25 2.25V18a2.25 2.25 0 0 1-2.25 2.25H6A2.25 2.25 0 0 1 3.75 18v-2.25ZM13.5 6a2.25 2.25 0 0 1 2.25-2.25H18A2.25 2.25 0 0 1 20.25 6v2.25A2.25 2.25 0 0 1 18 10.5h-2.25a2.25 2.25 0 0 1-2.25-2.25V6ZM13.5 15.75a2.25 2.25 0 0 1 2.25-2.25H18a2.25 2.25 0 0 1 2.25 2.25V18A2.25 2.25 0 0 1 18 20.25h-2.25A2.25 2.25 0 0 1 13.5 18v-2.25Z" />
            </svg>
            <h3 class="text-2xl font-bold text-white mb-2">У вас пока нет проектов</h3>
            <p class="text-white/80 mb-6">Свяжитесь с нами, чтобы начать работу над вашим дизайн-проектом</p>
            <button onclick="openFeedbackModal()" 
                class="inline-flex items-center gap-3 px-8 py-4 bg-white text-[#291F1E] font-bold rounded-lg hover:bg-gray-100 transition-colors">
                Связаться с нами
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="m4.5 19.5 15-15m0 0H8.25m11.25 0v11.25" />
                </svg>
            </button>
        </div>
        {% endif %}
    </div>
</section>

<section class="bg-[#564F40] py-12 md:py-0 md:h-[284px]">
    <div class="max-w-[1300px] mx-auto grid grid-cols-1 md:grid-cols-4 gap-8 md:gap-20 px-6 md:px-0 md:pt-12">
        <div data-aos="fade-up" class="flex flex-col items-center justify-center">
            <img src="{% static 'imgs/icons/icon1.svg' %}" alt="" class="w-12 h-12 md:w-auto md:h-auto">
            <h3 class="mt-4 mb-3 text-lg font-bold text-center text-white md:text-xl">Полный цикл работ</h3>
            <p class="text-white/70 leading-[140%] text-center text-sm md:text-base">От эскиза до готового
                интерьера — под ключ</p>
        </div>
        <div data-aos="fade-up" data-aos-delay="100" class="flex flex-col items-center justify-center">
            <img src="{% static 'imgs/icons/icon2.svg' %}" alt="" class="w-12 h-12 md:w-auto md:h-auto">
            <h3 class="mt-4 mb-3 text-lg font-bold text-center text-white md:text-xl">3D-визуализация</h3>
            <p class="text-white/70 leading-[140%] text-center text-sm md:text-base">Увидите свой будущий
                интерьер еще до начала ремонта</p>
        </div>
        <div data-aos="fade-up" data-aos-delay="200" class="flex flex-col items-center justify-center">
            <img src="{% static 'imgs/icons/icon3.svg' %}" alt="" class="w-12 h-12 md:w-auto md:h-auto">
            <h3 class="mt-4 mb-3 text-lg font-bold text-center text-white md:text-xl">Индивидуальный подход</h3>
            <p class="text-white/70 leading-[140%] text-center text-sm md:text-base">Интерьер, который отражает
                именно ваш характер</p>
        </div>
        <div data-aos="fade-up" data-aos-delay="300" class="flex flex-col items-center justify-center">
            <img src="{% static 'imgs/icons/icon4.svg' %}" alt="" class="w-12 h-12 md:w-auto md:h-auto">
            <h3 class="mt-4 mb-3 text-lg font-bold text-center text-white md:text-xl">Контроль качества</h3>
            <p class="text-white/70 leading-[140%] text-center text-sm md:text-base">Гарантия, что проект будет
                реализован точно по плану</p>
        </div>
    </div>
</section>
{% endblock %}

